<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Stickman World Stable</title>

<style>
body{
    margin:0;
    overflow:hidden;
    background:#87c9ff;
}
canvas{ display:block; }
</style>
</head>

<body>
<canvas id="game"></canvas>

<script>
"use strict";

/* ================= CANVAS ================= */

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* ================= INPUT ================= */

const keys = {};
window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

/* ================= IMAGE ================= */

const stickImg = new Image();
stickImg.src = "stickman.png";

/* ================= WORLD ================= */

const gravity = 0.7;

function groundHeight(x){
    let base = canvas.height * 0.75;
    base -= Math.sin(x * 0.002) * 40;
    base -= Math.sin(x * 0.0007) * 60;
    return base;
}

/* ================= PLAYER ================= */

const player = {
    x: 200,
    y: 0,
    vx: 0,
    vy: 0,

    width: 90,
    height: 220,

    accel: 1.1,
    maxSpeed: 10,
    friction: 0.82,
    jump: 17,

    onGround: false
};

/* ================= CAMERA ================= */

const camera = {
    x: 0,
    smooth: 0.08
};

/* ================= TREES ================= */

const trees = [];
let tx = 0;
for(let i=0;i<200;i++){
    tx += 200 + Math.random()*300;
    trees.push({
        x: tx,
        size: 0.7 + Math.random()*1.2
    });
}

/* ================= ROCKS ================= */

const rocks = [];
for(let i=0;i<40;i++){
    rocks.push({
        x: i*900 + 600 + Math.random()*200,
        size: 30 + Math.random()*40
    });
}

/* ================= UPDATE ================= */

function update(){

    /* movement */
    if(keys["a"]) player.vx -= player.accel;
    if(keys["d"]) player.vx += player.accel;

    if((keys["w"] || keys[" "]) && player.onGround){
        player.vy = -player.jump;
        player.onGround = false;
    }

    /* clamp speed */
    player.vx = Math.max(-player.maxSpeed, Math.min(player.maxSpeed, player.vx));

    /* physics */
    player.vx *= player.friction;
    player.vy += gravity;

    player.x += player.vx;
    player.y += player.vy;

    /* ground collision */
    const ground = groundHeight(player.x);

    if(player.y + player.height > ground){
        player.y = ground - player.height;
        player.vy = 0;
        player.onGround = true;
    }

    /* rock collision */
    rocks.forEach(r=>{
        if(Math.abs(player.x - r.x) < 45){
            const top = groundHeight(r.x) - r.size;
            if(player.y + player.height > top &&
               player.y + player.height < top + 40){
                player.y = top - player.height;
                player.vy = 0;
                player.onGround = true;
            }
        }
    });

    /* camera follow */
    const target = player.x - canvas.width*0.4;
    camera.x += (target - camera.x) * camera.smooth;
}

/* ================= DRAW ================= */

function drawSky(){

    ctx.fillStyle = "#87c9ff";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    /* mountains */
    ctx.fillStyle = "#6e8fb3";
    for(let i=-1;i<8;i++){
        let x = i*400 - (camera.x*0.2)%400;
        ctx.beginPath();
        ctx.moveTo(x, canvas.height*0.6);
        ctx.lineTo(x+200, canvas.height*0.4);
        ctx.lineTo(x+400, canvas.height*0.6);
        ctx.fill();
    }

    /* hills */
    ctx.fillStyle = "#5f9c6b";
    ctx.beginPath();
    ctx.moveTo(0, canvas.height*0.7);

    for(let x=0;x<canvas.width;x+=20){
        let wx = x + camera.x*0.5;
        let y = canvas.height*0.7 + Math.sin(wx*0.002)*40;
        ctx.lineTo(x,y);
    }

    ctx.lineTo(canvas.width, canvas.height);
    ctx.lineTo(0, canvas.height);
    ctx.fill();
}

function drawGround(){

    ctx.fillStyle = "#4caf50";

    ctx.beginPath();
    ctx.moveTo(0, canvas.height);

    for(let x=0;x<canvas.width;x+=10){
        let wx = x + camera.x;
        let y = groundHeight(wx);
        ctx.lineTo(x,y);
    }

    ctx.lineTo(canvas.width, canvas.height);
    ctx.closePath();
    ctx.fill();
}

function drawTrees(){
    trees.forEach(t=>{
        let x = t.x - camera.x;
        if(x < -200 || x > canvas.width+200) return;

        let ground = groundHeight(t.x);
        let h = 120 * t.size;

        ctx.fillStyle = "#6b3f1d";
        ctx.fillRect(x, ground-h, 20*t.size, h);

        ctx.fillStyle = "#2e7d32";
        ctx.beginPath();
        ctx.arc(x+10*t.size, ground-h, 50*t.size, 0, Math.PI*2);
        ctx.fill();
    });
}

function drawRocks(){
    ctx.fillStyle = "#777";
    rocks.forEach(r=>{
        let x = r.x - camera.x;
        let y = groundHeight(r.x) - r.size;

        ctx.beginPath();
        ctx.arc(x, y, r.size, 0, Math.PI*2);
        ctx.fill();
    });
}

function drawPlayer(){
    if(!stickImg.complete) return;

    let screenX = player.x - camera.x;

    ctx.drawImage(
        stickImg,
        screenX - player.width/2,
        player.y,
        player.width,
        player.height
    );
}

/* ================= LOOP ================= */

let running = false;

function gameLoop(){
    if(!running) return;

    update();

    drawSky();
    drawGround();
    drawTrees();
    drawRocks();
    drawPlayer();

    requestAnimationFrame(gameLoop);
}

/* ================= TAB FIX ================= */

document.addEventListener("visibilitychange", ()=>{
    if(!document.hidden){
        running = true;
        gameLoop();
    }
});

/* ================= START ================= */

stickImg.onload = () => {

    /* spawn safely on ground */
    player.y = groundHeight(player.x) - player.height;

    /* set camera start */
    camera.x = player.x - canvas.width*0.4;

    running = true;
    gameLoop();
};

</script>
</body>
</html>
